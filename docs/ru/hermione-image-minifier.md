# hermione-image-minifier

## Обзор

Используйте плагин `hermione-image-minifier`, чтобы сжимать изображения (скриншоты) в своих тестах.

Плагин поддерживает 8 степеней сжатия: от 0 (не применять сжатие) до 7 (максимальная степень сжатия).

### Как это работает?

При запуске плагин подписывается на событие `UPDATE_REFERENCE`, которое гермиона посылает в случаях:
* если пользователь запустил гермиону, передав ей опцию `--update-refs`;
* если пользователь обновляет или сохраняет скриншоты с помощью плагина [html-reporter][html-reporter].

Когда в плагин `hermione-image-minifier` прилетает событие `UPDATE_REFERENCE`, он получает вместе с событием ссылку на само изображение. Далее плагин применяет к полученному изображению алгоритм сжатия с указанной в конфиге степенью сжатия. И сохраняет новое изображение на файловую систему. После этого разработчик может влить обновленные файлы в главную ветку своего проекта.

Для сжатия изображений плагин `hermione-image-minifier` использует пакет [optipng-bin][optipng-bin].

_Выбирая степень сжатия для изображений в своем проекте, помните, что вы выбираете между скоростью и местом, которое будут занимать ваши изображения на диске. Чем выше степень сжатия, тем меньше места будут занимать ваши изображения на диске, но дольше будут выполняться сами тесты. Так как перед тем как сравнивать изображения в тестах система должна будет их распаковать. Поэтому, чтобы получить приемлемое время прогона тестов, соизмеряйте выбираемую степень сжатия с мощностью серверов, на которых эти тесты будут выполняться._

## Установка

```bash
npm install -D hermione-image-minifier
```

## Настройка

Необходимо подключить плагин в разделе `plugins` конфига `hermione`:

```javascript
module.exports = {
    plugins: {
        'hermione-image-minifier': {
            enabled: true, // Включить плагин.
            compressionLevel: 7 // Максимальный уровень компрессии, сжатие займет какое-то время
        },

        // другие плагины гермионы...
    },

    // другие настройки гермионы...
};
```

### Расшифровка параметров конфигурации

| **Параметр** | **Тип** | **По&nbsp;умолчанию** | **Описание** |
| :--- | :---: | :---: | :--- |
| enabled | Boolean | true | Включить / отключить плагин. |
| compressionLevel | Number | 2 | Степень сжатия изображения: от 0 до 7 (максимальная степень сжатия). |

### Передача параметров через CLI

Все параметры плагина, которые можно определить в конфиге, можно также передать в виде опций командной строки или через переменные окружения во время запуска гермионы. Используйте префикс `--image-minifier-` для опций командной строки и `hermione_image_minifier_` &mdash; для переменных окружения. Например:

```bash
npx hermione --image-minifier-compression-level 5
```

```bash
hermione_image_minifier_compression_level = 5 npx hermione
```

## Отладка

Установите переменную окружения `DEBUG=hermione:image-minifier`, чтобы видеть сообщения о применении алгоритма сжатия для изображений в тестах.

```bash
DEBUG=hermione:image-minifier npx hermione --update-refs
```

Пример, как это будет выглядеть в консоли:

```bash
/path/to/reference/image.png compressed by 30%
```

## Использование

После добавления плагина в проект и настройки его параметров запустите гермиону с опцией `--update-refs`:

```bash
npx hermione --update-refs
```

Изображения на файловой системе будут обновлены.

## Полезные ссылки

* [Исходники плагина hermione-image-minifier][hermione-image-minifier]
* [Пакет для сжатия изображений optipng-bin][optipng-bin]

[hermione-image-minifier]: https://github.com/gemini-testing/hermione-image-minifier/
[html-reporter]: https://docs.yandex-team.ru/hermione/plugins/html-reporter
[optipng-bin]: https://www.npmjs.com/package/optipng-bin
